<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adivina Quien</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="terminal-body">
    <div class="scanline"></div>

    <div class="main-wrapper">
        <header>
            <div class="brand">
                <h1 style="color: var(--p1-color); margin:0; font-size: 1.5rem;">
                    > Adivina Quien <span class="blink"> ¿Puedes?</span>
                </h1>
            </div>
            <div id="timer">00:00</div>
        </header>

        <div class="dual-screen">
            <div class="player-section" id="board-JUGADOR-1-parent">
                <div class="player-header p1-header">JUGADOR 1 </div>
                <div class="grid-terminal" id="board-JUGADOR-1">
                    </div>
            </div>

            <div class="player-section" id="board-JUGADOR-2-parent">
                <div class="player-header p2-header">JUGADOR 2 </div>
                <div class="grid-terminal" id="board-JUGADOR-2">
                    </div>
            </div>
        </div>
        </div>

    <div id="victory-overlay">
        <h1 class="blink">OBJETIVO CONFIRMADO</h1>
        <h2 id="winner-text">GANADOR</h2>
        <p>REINICIE DESDE EL DISPOSITIVO MÓVIL</p>
    </div>

    <script>
        const socket = io();
        let timerInterval;

        // Registrar este dispositivo como la pantalla principal (TV)
        socket.emit('register-device', 'tv');

        // Escuchar cuando el servidor envía los tableros generados
        socket.on('tv-setup', data => {
            renderBoard('JUGADOR-1', data.p1Board);
            renderBoard('JUGADOR-2', data.p2Board);
        });

        // Función para dibujar los personajes en la rejilla
        function renderBoard(role, list) {
            const container = document.getElementById(`board-${role}`);
            container.innerHTML = ''; // Limpiar tablero anterior

            list.forEach(personaje => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.id = `char-${role}-${personaje.id}`;

                card.innerHTML = `
                    <div class="img-container">
                        <img src="${personaje.url}" alt="${personaje.nombre}">
                    </div>
                    <div class="name">${personaje.nombre}</div>
                `;
                container.appendChild(card);
            });
        }

        // Iniciar el cronómetro cuando el servidor lo indique
        socket.on('start-timer', () => {
            let seconds = 0;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                let min = Math.floor(seconds / 60).toString().padStart(2, '0');
                let seg = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${min}:${seg}`;
            }, 1000);
        });

        // Marcar personaje como eliminado (con la X roja)
        socket.on('visual-discard', data => {
            // Convertimos "JUGADOR 1" a "JUGADOR-1" para que coincida con el ID
            const roleId = data.role.replace(' ', '-');
            const card = document.getElementById(`char-${roleId}-${data.id}`);
            if (card) {
                card.classList.toggle('eliminated');
            }
        });

        // Mostrar pantalla final de victoria
        socket.on('game-over', data => {
            clearInterval(timerInterval);
            const overlay = document.getElementById('victory-overlay');
            const winnerText = document.getElementById('winner-text');
            
            overlay.style.display = 'flex';
            winnerText.textContent = `${data.player} IDENTIFICÓ A: ${data.character}`;
            
            // Cambiar color del texto según el ganador
            winnerText.style.color = (data.player === 'JUGADOR 1') ? 'var(--p1-color)' : 'var(--p2-color)';
        });

        // Reiniciar la página completa para una nueva partida
        socket.on('reset-game', () => {
            location.reload();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablero Adivina Quien</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ajuste específico para Android y navegadores móviles */
        :root {
            --doc-height: 100vh;
        }

        body {
            height: var(--doc-height);
            width: 100vw;
            overflow: hidden;
            position: fixed; /* Evita el rebote de scroll en móviles */
        }

        .main-wrapper {
            height: var(--doc-height);
        }

        /* Aseguramos que el grid sea flexible pero contenido */
        .grid-terminal {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 23%); /* Forzamos un alto relativo seguro */
            align-content: stretch;
        }

        @media (max-width: 600px) {
            .dual-screen {
                flex-direction: column; /* En móviles muy pequeños los pone uno sobre otro */
            }
        }
    </style>
</head>
<body class="terminal-body">
    <div class="scanline"></div>

    <div class="main-wrapper">
        <header class="compact-header">
            <div class="brand">
                <span style="color: var(--p1-color); font-size: 0.8rem; letter-spacing: 2px;">
                    > SYSTEM_STATUS: <span class="blink">ACTIVE_LINK</span>
                </span>
            </div>
        </header>

        <div class="dual-screen">
            <div class="player-section" id="board-JUGADOR-1-parent">
                <div class="player-header p1-header">JUGADOR 1</div>
                <div class="grid-terminal" id="board-JUGADOR-1"></div>
            </div>

            <div class="player-section" id="board-JUGADOR-2-parent">
                <div class="player-header p2-header">JUGADOR 2</div>
                <div class="grid-terminal" id="board-JUGADOR-2"></div>
            </div>
        </div>
    </div>

    <div id="victory-overlay">
        <h1 class="blink">OBJETIVO CONFIRMADO</h1>
        <h2 id="winner-text">GANADOR</h2>
        <p>REINICIE DESDE EL DISPOSITIVO MÓVIL</p>
    </div>

    <script>
        const socket = io();

        // TRUCO PARA ANDROID: Recalcular el alto real de la ventana
        const documentHeight = () => {
            const doc = document.documentElement;
            doc.style.setProperty('--doc-height', `${window.innerHeight}px`);
        };
        window.addEventListener('resize', documentHeight);
        documentHeight();

        socket.emit('register-device', 'tv');

        socket.on('tv-setup', data => {
            renderBoard('JUGADOR-1', data.p1Board);
            renderBoard('JUGADOR-2', data.p2Board);
        });

        function renderBoard(role, list) {
            const container = document.getElementById(`board-${role}`);
            container.innerHTML = ''; 

            list.forEach(personaje => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.id = `char-${role}-${personaje.id}`;

                const cleanUrl = personaje.url.trim() + "?v=" + Date.now();

                card.innerHTML = `
                    <div class="img-container">
                        <img src="${cleanUrl}" 
                             onload="this.style.opacity='1'"
                             onerror="this.src='https://via.placeholder.com/150?text=Error'"
                             alt="${personaje.nombre}">
                    </div>
                    <div class="name">${personaje.nombre}</div>
                `;
                container.appendChild(card);
            });
        }

        socket.on('visual-discard', data => {
            const roleId = data.role.replace(' ', '-');
            const card = document.getElementById(`char-${roleId}-${data.id}`);
            if (card) card.classList.toggle('eliminated');
        });

        socket.on('game-over', data => {
            const overlay = document.getElementById('victory-overlay');
            const winnerText = document.getElementById('winner-text');
            overlay.style.display = 'flex';
            winnerText.textContent = `${data.player} IDENTIFICÓ A: ${data.character}`;
            winnerText.style.color = (data.player === 'JUGADOR 1') ? 'var(--p1-color)' : 'var(--p2-color)';
        });

        socket.on('reset-game', () => location.reload());
    </script>
</body>
</html>

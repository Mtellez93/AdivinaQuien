<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONTROLLER - TACTICAL GUESS</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Estilos específicos para el móvil que no afectan a la TV */
        body { overflow-y: auto; height: auto; padding-bottom: 50px; }
        .mobile-container { padding: 15px; text-align: center; }
        .secret-banner { 
            background: #1a1a1a; 
            border: 2px solid var(--p1-color); 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 8px;
        }
        .grid-mobile {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .btn-guess {
            background: var(--red);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            font-weight: bold;
            margin-top: 20px;
            border-radius: 5px;
        }
        .loading-screen {
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="mobile-container" id="game-container">
        <div id="setup-zone">
            <div class="loading-screen">
                <p class="blink">ESPERANDO INICIO DE PARTIDA...</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myRole = "";

        // 1. Registro inicial
        socket.emit('register-device', 'mobile');

        socket.on('assign-role', role => {
            myRole = role;
            document.title = `CONTROLLER - ${role}`;
        });

        // 2. Recepción del Tablero y Objetivo (LOGICA CORREGIDA)
        socket.on('game-setup', data => {
            const container = document.getElementById('game-container');
            
            // Definir color según el rol
            const accentColor = (myRole === 'JUGADOR 1') ? 'var(--p1-color)' : 'var(--p2-color)';

            container.innerHTML = `
                <div class="secret-banner" style="border-color: ${accentColor}">
                    <p style="margin:0; font-size: 0.8rem; color: #888;">OBJETIVO QUE EL RIVAL DEBE BUSCAR:</p>
                    <h2 style="margin:5px 0; color: ${accentColor}">${data.secret}</h2>
                </div>

                <div class="grid-mobile" id="mobile-grid"></div>

                <button class="btn-guess" onclick="guessWho()">¡LO TENGO!</button>
                <button style="margin-top:10px; background:#333; color:white; border:none; padding:10px; width:100%; border-radius:5px;" onclick="requestReset()">REINICIAR TODO</button>
            `;

            const grid = document.getElementById('mobile-grid');
            data.board.forEach(personaje => {
                const btn = document.createElement('div');
                btn.className = 'char-card';
                btn.id = `mobile-char-${personaje.id}`;
                btn.style.padding = "10px";
                btn.innerHTML = `
                    <div class="name" style="font-size:0.8rem">${personaje.nombre}</div>
                `;
                btn.onclick = () => discard(personaje.id, personaje.nombre);
                grid.appendChild(btn);
            });
        });

        // 3. Acciones de Juego
        function discard(id, nombre) {
            const card = document.getElementById(`mobile-char-${id}`);
            card.classList.toggle('eliminated');
            
            // Notificar a la TV
            socket.emit('discard-character', {
                role: myRole,
                id: id
            });
        }

        function guessWho() {
            const name = prompt("¿QUIÉN ES EL OBJETIVO DEL RIVAL?");
            if (name) {
                socket.emit('declare-winner', {
                    player: myRole,
                    character: name.trim().toUpperCase()
                });
            }
        }

        function requestReset() {
            if(confirm("¿REINICIAR LA PARTIDA PARA TODOS?")) {
                socket.emit('request-reset');
            }
        }

        socket.on('guess-error', msg => alert(msg));
        socket.on('reset-game', () => location.reload());
    </script>
</body>
</html>
